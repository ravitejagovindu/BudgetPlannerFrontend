<div class="planner-container fade-in">

  <!-- Header -->
  <div class="row mb-4">
    <div class="col-12">
      <h1 class="page-title">
        <i class="bi bi-gear-wide-connected me-2"></i>Manage Planner
      </h1>
      <p class="page-subtitle">Configure your budget structure, categories and subcategories</p>
    </div>
  </div>

  <!-- Global Alert -->
  <div class="row mb-3" *ngIf="alertMessage">
    <div class="col-12">
      <div class="alert shadow-sm border-0 d-flex align-items-center"
        [ngClass]="alertType === 'success' ? 'alert-success text-success bg-success-subtle' : 'alert-danger text-danger bg-danger-subtle'"
        role="alert">
        <i class="bi me-2 fs-5"
          [ngClass]="alertType === 'success' ? 'bi-check-circle-fill' : 'bi-exclamation-triangle-fill'"></i>
        <div>{{ alertMessage }}</div>
      </div>
    </div>
  </div>

  <!-- Main Content Card -->
  <div class="card border-0 shadow-sm rounded-4 bg-white">
    <div class="card-body p-4">

      <form [formGroup]="plannerForm" (ngSubmit)="onSubmit()">

        <!-- Step 1: Select Budget Type -->
        <div class="row mb-4">
          <div class="col-md-6">
            <label class="form-label fw-bold text-secondary">1. Select Budget Type</label>
            <select class="form-select form-select-lg"
              [class.is-invalid]="plannerForm.get('budgetType')?.invalid && (plannerForm.get('budgetType')?.dirty || plannerForm.get('budgetType')?.touched)"
              formControlName="budgetType">
              <option value="" disabled selected>Choose Type...</option>
              <option *ngFor="let type of budgetTypes" [value]="type">{{ type }}</option>
            </select>
            <div class="invalid-feedback">Please select a budget type.</div>
          </div>
        </div>

        <div *ngIf="selectedType">
          <hr class="text-muted opacity-25 my-4">

          <!-- Step 2: Select Action (New or Existing) -->
          <div class="row mb-4">
            <div class="col-md-12">
              <label class="form-label fw-bold text-secondary d-block">2. Choose Action</label>
              <div class="btn-group w-100 w-md-50" role="group">
                <input type="radio" class="btn-check" formControlName="creationMode" value="existing" id="modeExisting">
                <label class="btn btn-outline-primary" for="modeExisting">
                  <i class="bi bi-pencil-square me-2"></i>Edit Existing
                </label>

                <input type="radio" class="btn-check" formControlName="creationMode" value="new" id="modeNew">
                <label class="btn btn-outline-success" for="modeNew">
                  <i class="bi bi-plus-lg me-2"></i>Create New
                </label>
              </div>
            </div>
          </div>

          <!-- Step 3: Category Details -->
          <div class="row g-3 mb-4">
            <!-- If Existing: Show Dropdown -->
            <div class="col-md-6" *ngIf="creationMode === 'existing'">
              <label class="form-label fw-bold text-secondary">Select Category</label>
              <select class="form-select" formControlName="selectedCategoryId">
                <option value="" disabled selected>Select a category to edit...</option>
                <option *ngFor="let cat of filteredCategories" [value]="cat.id">
                  {{ cat.categoryName }} (₹{{ cat.categoryAmount }})
                </option>
              </select>
              <div class="form-text text-muted" *ngIf="filteredCategories.length === 0">No categories found for {{
                selectedType }}. Create a new one.</div>
            </div>

            <!-- Category Name Input -->
            <div class="col-md-6">
              <label class="form-label fw-bold text-secondary">Category Name</label>
              <input type="text" class="form-control"
                [class.is-invalid]="plannerForm.get('categoryName')?.invalid && (plannerForm.get('categoryName')?.dirty || plannerForm.get('categoryName')?.touched)"
                formControlName="categoryName" placeholder="e.g. Groceries">
              <div class="invalid-feedback">Category Name is required.</div>
            </div>

            <!-- Category Amount Input -->
            <div class="col-md-6">
              <label class="form-label fw-bold text-secondary">Total Allocated Amount (₹)</label>
              <div class="input-group">
                <span class="input-group-text bg-white border-end-0 text-muted">₹</span>
                <input type="number" class="form-control border-start-0 ps-0"
                  [class.is-invalid]="plannerForm.get('categoryAmount')?.invalid && (plannerForm.get('categoryAmount')?.dirty || plannerForm.get('categoryAmount')?.touched)"
                  formControlName="categoryAmount" placeholder="0.00">
                <div class="invalid-feedback">Amount is required and must be greater than 0.</div>
              </div>
            </div>
          </div>

          <!-- Section Visibility Check -->
          <div
            *ngIf="creationMode === 'new' || (creationMode === 'existing' && plannerForm.get('selectedCategoryId')?.value)">

            <hr class="text-muted opacity-25 my-4">

            <!-- Step 4: Subcategories -->
            <div class="row mb-2 align-items-center">
              <div class="col">
                <h5 class="fw-bold text-dark mb-0">
                  <i class="bi bi-diagram-3 me-2 text-primary"></i>Subcategories
                </h5>
                <p class="text-muted small mb-0"
                  [class.text-danger]="subCategories.length === 0 && plannerForm.touched">
                  At least one subcategory with an amount is required.
                </p>
              </div>
              <div class="col-auto">
                <button type="button" class="btn btn-outline-primary btn-sm" (click)="addSubCategory()">
                  <i class="bi bi-plus-lg me-1"></i> Add Subcategory
                </button>
              </div>
            </div>

            <div class="bg-light rounded-3 p-3 mb-4">
              <div formArrayName="subCategories">
                <div *ngFor="let sub of subCategories.controls; let i = index" [formGroupName]="i"
                  class="row g-2 align-items-center mb-2">
                  <div class="col-md-6">
                    <input type="text" class="form-control form-control-sm"
                      [class.is-invalid]="sub.get('name')?.invalid && (sub.get('name')?.dirty || sub.get('name')?.touched)"
                      formControlName="name" placeholder="Name (e.g. Vegetables)">
                    <div class="invalid-feedback">Name is required.</div>
                  </div>
                  <div class="col-md-4">
                    <div class="input-group input-group-sm has-validation">
                      <span class="input-group-text bg-white border-end-0">₹</span>
                      <input type="number" class="form-control border-start-0"
                        [class.is-invalid]="sub.get('amount')?.invalid && (sub.get('amount')?.dirty || sub.get('amount')?.touched)"
                        formControlName="amount" placeholder="0.00">
                      <div class="invalid-feedback">Amount > 0 required.</div>
                    </div>
                  </div>
                  <div class="col-md-2 text-end">
                    <button type="button" class="btn btn-outline-danger btn-sm border-0" (click)="removeSubCategory(i)"
                      title="Remove">
                      <i class="bi bi-trash"></i>
                    </button>
                  </div>
                </div>
                <div *ngIf="subCategories.length === 0" class="text-center text-danger py-3">
                  <small><i class="bi bi-exclamation-circle me-1"></i> No subcategories added. Please add at least
                    one.</small>
                </div>
              </div>
            </div>

            <!-- Actions -->
            <div class="d-flex justify-content-between align-items-center pt-3 border-top">
              <button type="button" class="btn btn-outline-danger" *ngIf="creationMode === 'existing'"
                (click)="deleteCategory()">
                <i class="bi bi-trash me-2"></i>Delete Category
              </button>
              <div class="ms-auto">
                <button type="button" class="btn btn-light me-2" (click)="resetSelection()">Cancel</button>
                <button type="submit" class="btn btn-primary px-4"
                  [disabled]="loading || plannerForm.invalid || subCategories.length === 0">
                  <span *ngIf="loading" class="spinner-border spinner-border-sm me-2" role="status"
                    aria-hidden="true"></span>
                  <i class="bi bi-check-lg me-2" *ngIf="!loading"></i>
                  {{ creationMode === 'new' ? 'Create Category' : 'Save Changes' }}
                </button>
              </div>
            </div>

          </div>
          <!-- End Details Section -->

        </div>
        <!-- End Selected Type Section -->

      </form>

    </div>
  </div>

</div>