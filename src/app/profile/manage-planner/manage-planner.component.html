<!-- ============================================== -->
<!-- MANAGE PLANNER COMPONENT -->
<!-- Category and Subcategory Management Interface -->
<!-- ============================================== -->

<div class="planner-container">
  <!-- Header Section -->
  <div class="planner-header">
    <div class="row align-items-center">
      <div class="col-md-8">
        <h1 class="page-title">
          <i class="bi bi-gear-fill me-3"></i>Manage Categories
        </h1>
        <p class="page-subtitle">Configure your budget categories and subcategories</p>
      </div>
    </div>
  </div>

  <!-- Alert Messages - Global -->
  <div class="row" *ngIf="alertMessage">
    <div class="col-12">
      <div class="alert" [ngClass]="alertType === 'success' ? 'alert-success' : 'alert-danger'" role="alert">
        <i class="bi me-2"
          [ngClass]="alertType === 'success' ? 'bi-check-circle-fill' : 'bi-exclamation-triangle-fill'"></i>
        {{ alertMessage }}
        <button type="button" class="btn-close" (click)="closeAlert()"></button>
      </div>
    </div>
  </div>

  <!-- Main Content -->
  <div class="row">
    <!-- Section 1: Add New Category -->
    <div class="col-lg-6 mb-4">
      <div class="card form-card">
        <div class="card-header">
          <h5 class="card-title mb-0">
            <i class="bi bi-plus-circle-fill me-2"></i>Add New Category
          </h5>
        </div>
        <div class="card-body">
          <form [formGroup]="categoryForm" (ngSubmit)="onSubmitNewCategory()">
            <!-- Budget Type Selection -->
            <div class="form-group mb-3">
              <label for="budgetType" class="form-label">
                <i class="bi bi-tag-fill me-2"></i>Budget Type <span class="text-danger">*</span>
              </label>
              <select class="form-select form-control" formControlName="budgetType" id="budgetType"
                [class.is-invalid]="categoryForm.get('budgetType')?.invalid && categoryForm.get('budgetType')?.touched">
                <option value="">Select Budget Type</option>
                <option *ngFor="let type of budgetTypes" [value]="type">{{ type }}</option>
              </select>
              <div class="invalid-feedback"
                *ngIf="categoryForm.get('budgetType')?.invalid && categoryForm.get('budgetType')?.touched">
                Please select a budget type
              </div>
            </div>

            <!-- Category Name -->
            <div class="form-group mb-3">
              <label for="categoryName" class="form-label">
                <i class="bi bi-bookmark-fill me-2"></i>Category Name <span class="text-danger">*</span>
              </label>
              <input type="text" class="form-control" formControlName="categoryName" id="categoryName"
                placeholder="Enter category name (e.g., Groceries, Rent)"
                [class.is-invalid]="categoryForm.get('categoryName')?.invalid && categoryForm.get('categoryName')?.touched" />
              <div class="invalid-feedback"
                *ngIf="categoryForm.get('categoryName')?.invalid && categoryForm.get('categoryName')?.touched">
                Category name is required
              </div>
            </div>

            <!-- Category Amount -->
            <div class="form-group mb-3">
              <label for="categoryAmount" class="form-label">
                <i class="bi bi-currency-rupee me-2"></i>Category Amount <span class="text-danger">*</span>
              </label>
              <input type="number" class="form-control" formControlName="categoryAmount" id="categoryAmount"
                placeholder="Enter total amount for this category" min="0" step="0.01"
                [class.is-invalid]="categoryForm.get('categoryAmount')?.invalid && categoryForm.get('categoryAmount')?.touched" />
              <div class="invalid-feedback"
                *ngIf="categoryForm.get('categoryAmount')?.invalid && categoryForm.get('categoryAmount')?.touched">
                Category amount is required and must be greater than 0
              </div>
            </div>

            <!-- Subcategories Section -->
            <div class="form-group mb-3">
              <label class="form-label">
                <i class="bi bi-list-ul me-2"></i>Subcategories <span class="text-danger">*</span>
                <small class="text-muted">(At least one required)</small>
              </label>

              <div formArrayName="subCategories">
                <div *ngFor="let sub of subCategories.controls; let i = index" class="subcategory-row mb-2">
                  <div class="input-group">
                    <input type="text" class="form-control" [formControlName]="i" placeholder="Subcategory name"
                      [class.is-invalid]="sub.invalid && sub.touched" />
                    <button type="button" class="btn btn-outline-danger" (click)="removeSubCategory(i)"
                      [disabled]="subCategories.length === 1" title="Remove subcategory">
                      <i class="bi bi-trash"></i>
                    </button>
                  </div>
                  <div class="invalid-feedback d-block" *ngIf="sub.invalid && sub.touched">
                    Subcategory name is required
                  </div>
                </div>
              </div>

              <button type="button" class="btn btn-outline-success btn-sm mt-2" (click)="addSubCategory()">
                <i class="bi bi-plus-circle me-1"></i>Add Subcategory
              </button>
            </div>

            <!-- Submit Button -->
            <div class="d-grid gap-2">
              <button type="submit" class="btn btn-primary btn-lg" [disabled]="categoryForm.invalid || loading">
                <span *ngIf="!loading">
                  <i class="bi bi-save me-2"></i>Save Category
                </span>
                <span *ngIf="loading">
                  <span class="spinner-border spinner-border-sm me-2" role="status"></span>
                  Saving...
                </span>
              </button>
            </div>
          </form>
        </div>
      </div>
    </div>

    <!-- Section 2: Add Subcategories to Existing Category -->
    <div class="col-lg-6 mb-4">
      <div class="card form-card">
        <div class="card-header bg-info">
          <h5 class="card-title mb-0 text-white">
            <i class="bi bi-folder-plus me-2"></i>Add Subcategories to Existing Category
          </h5>
        </div>
        <div class="card-body">
          <form [formGroup]="existingCategoryForm" (ngSubmit)="onSubmitExistingCategory()">
            <!-- Select Existing Category -->
            <div class="form-group mb-3">
              <label for="existingCategory" class="form-label">
                <i class="bi bi-folder-fill me-2"></i>Select Category <span class="text-danger">*</span>
              </label>
              <select class="form-select form-control" formControlName="selectedCategoryId" id="existingCategory"
                [class.is-invalid]="existingCategoryForm.get('selectedCategoryId')?.invalid && existingCategoryForm.get('selectedCategoryId')?.touched">
                <option value="">Choose a category</option>
                <option *ngFor="let cat of allCategories" [value]="cat.id">
                  {{ cat.budgetType }} - {{ cat.categoryName }}
                </option>
              </select>
              <div class="invalid-feedback"
                *ngIf="existingCategoryForm.get('selectedCategoryId')?.invalid && existingCategoryForm.get('selectedCategoryId')?.touched">
                Please select a category
              </div>
              <small class="form-text text-muted" *ngIf="allCategories.length === 0">
                No categories available. Please add a new category first.
              </small>
            </div>

            <!-- New Subcategories Section -->
            <div class="form-group mb-3">
              <label class="form-label">
                <i class="bi bi-list-ul me-2"></i>New Subcategories <span class="text-danger">*</span>
              </label>

              <div formArrayName="newSubCategories">
                <div *ngFor="let sub of newSubCategories.controls; let i = index" class="subcategory-row mb-2">
                  <div class="input-group">
                    <input type="text" class="form-control" [formControlName]="i" placeholder="Subcategory name"
                      [class.is-invalid]="sub.invalid && sub.touched" />
                    <button type="button" class="btn btn-outline-danger" (click)="removeNewSubCategory(i)"
                      [disabled]="newSubCategories.length === 1" title="Remove subcategory">
                      <i class="bi bi-trash"></i>
                    </button>
                  </div>
                  <div class="invalid-feedback d-block" *ngIf="sub.invalid && sub.touched">
                    Subcategory name is required
                  </div>
                </div>
              </div>

              <button type="button" class="btn btn-outline-info btn-sm mt-2" (click)="addNewSubCategory()">
                <i class="bi bi-plus-circle me-1"></i>Add Subcategory
              </button>
            </div>

            <!-- Submit Button -->
            <div class="d-grid gap-2">
              <button type="submit" class="btn btn-info btn-lg text-white"
                [disabled]="existingCategoryForm.invalid || newSubCategories.length === 0 || loading">
                <span *ngIf="!loading">
                  <i class="bi bi-save me-2"></i>Add to Category
                </span>
                <span *ngIf="loading">
                  <span class="spinner-border spinner-border-sm me-2" role="status"></span>
                  Adding...
                </span>
              </button>
            </div>
          </form>
        </div>
      </div>
    </div>
  </div>
</div>
