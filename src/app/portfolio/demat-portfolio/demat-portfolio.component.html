<div class="row fade-in">
    <div class="col-12">

        <!-- Secondary Tabs (Pills) -->
        <div class="d-flex justify-content-center mb-4">
            <div class="bg-light p-1 rounded-pill d-inline-flex border">
                <button class="btn btn-sm rounded-pill px-4 fw-bold transition-all"
                    [class.btn-white]="activeTab === 'zerodha'" [class.shadow-sm]="activeTab === 'zerodha'"
                    [class.text-primary]="activeTab === 'zerodha'" [class.text-muted]="activeTab !== 'zerodha'"
                    (click)="setActiveTab('zerodha')">
                    <img src="https://zerodha.com/static/images/logo.svg" alt="Zerodha" class="me-2"
                        style="height: 16px; opacity: 0.8;">
                    Zerodha
                </button>
                <button class="btn btn-sm rounded-pill px-4 fw-bold transition-all"
                    [class.btn-white]="activeTab === 'other'" [class.shadow-sm]="activeTab === 'other'"
                    [class.text-primary]="activeTab === 'other'" [class.text-muted]="activeTab !== 'other'"
                    (click)="setActiveTab('other')">
                    <i class="bi bi-briefcase text-secondary me-2"></i>Other Investments
                </button>
            </div>
        </div>

        <!-- ============================================== -->
        <!-- TAB: ZERODHA -->
        <!-- ============================================== -->
        <div *ngIf="activeTab === 'zerodha'" class="fade-in">

            <div class="row g-4">
                <!-- LOOP: Multiple Zerodha Accounts -->
                <ng-container *ngFor="let account of brokerAccounts; let i = index">

                    <!-- DYNAMIC GRID COLUMN: Full width if showing holdings, else compact -->
                    <div [ngClass]="(account.showHoldings || account.showMutualFunds) ? 'col-12' : 'col-md-6'">

                        <!-- CASE 1: NOT CONNECTED (SIMPLIFIED) -->
                        <div *ngIf="!account.broker.authenticated"
                            class="card summary-card h-100 border-start-primary text-center">
                            <div class="card-body py-4 d-flex flex-column justify-content-center align-items-center">
                                <div class="icon-circle bg-primary-subtle text-primary mb-3">
                                    <i class="bi bi-link-45deg fs-2"></i>
                                </div>

                                <h5 class="fw-bold mb-1">Connect Zerodha</h5>
                                <p class="text-muted small mb-3">Client ID: {{ account.broker.clientId }}</p>

                                <button class="btn btn-primary btn-sm px-4 rounded-pill w-75"
                                    (click)="connectToZerodha(account)" [disabled]="account.loading">
                                    <span *ngIf="!account.loading">Connect</span>
                                    <span *ngIf="account.loading"><span
                                            class="spinner-border spinner-border-sm"></span></span>
                                </button>
                            </div>
                        </div>

                        <!-- CASE 2: CONNECTED (COMPACT OVERVIEW) -->
                        <div *ngIf="account.broker.authenticated && !account.showHoldings && !account.showMutualFunds"
                            class="card summary-card h-100 border-start-success">
                            <div class="card-body p-4 d-flex flex-column justify-content-center">
                                <div class="d-flex justify-content-between align-items-start mb-3">
                                    <div class="d-flex align-items-center">
                                        <div class="icon-square bg-success-subtle text-success rounded me-3">
                                            <i class="bi bi-check-lg fs-4"></i>
                                        </div>
                                        <div>
                                            <h6 class="fw-bold mb-0 text-dark">{{ account.broker.username }}</h6>
                                            <span class="text-muted small font-monospace">{{ account.broker.clientId
                                                }}</span>
                                        </div>
                                    </div>
                                    <button class="btn btn-sm btn-link text-danger-emphasis p-1" type="button"
                                        title="Disconnect Account" (click)="initiateDisconnect(account)"
                                        [disabled]="account.loading">
                                        <i class="bi bi-power fs-5"></i>
                                    </button>
                                </div>

                                <div class="d-grid gap-2">
                                    <button class="btn btn-outline-primary btn-sm text-start"
                                        (click)="viewHoldings(account)" [disabled]="account.loading">
                                        <i class="bi bi-graph-up me-2"></i>View Stocks
                                    </button>
                                    <button class="btn btn-outline-info btn-sm text-start"
                                        (click)="viewMutualFunds(account)" [disabled]="account.loading">
                                        <i class="bi bi-pie-chart me-2"></i>View Mutual Funds
                                    </button>
                                </div>
                            </div>
                        </div>

                        <!-- CASE 3: HOLDINGS VIEW (Expanded to col-12) -->
                        <div *ngIf="account.broker.authenticated && account.showHoldings">

                            <!-- Header -->
                            <div class="d-flex justify-content-between align-items-center mb-4">
                                <div>
                                    <h4 class="fw-bold text-dark mb-1">
                                        Stock Holdings ({{ account.portfolioHoldings.length }})
                                    </h4>
                                    <p class="text-muted mb-0 small">Account: {{ account.broker.username }}</p>
                                </div>
                                <div class="btn-group">
                                    <button class="btn btn-outline-secondary btn-sm"
                                        (click)="account.showHoldings = false">
                                        <i class="bi bi-arrow-left me-1"></i> Back
                                    </button>
                                    <button class="btn btn-outline-primary btn-sm" (click)="viewHoldings(account)"
                                        [disabled]="account.loading">
                                        <i class="bi bi-arrow-clockwise"></i>
                                    </button>
                                </div>
                            </div>

                            <!-- Summary Cards (Restored Full Richness) -->
                            <div class="row g-3 mb-4">
                                <!-- Total Investment -->
                                <div class="col-md-3">
                                    <div class="card summary-card border-start-primary h-100">
                                        <div class="card-body">
                                            <h6 class="text-uppercase text-muted small fw-bold mb-2">Total Investment
                                            </h6>
                                            <h4 class="fw-bold text-dark mb-0">₹{{
                                                getTotalInvestment(account.portfolioHoldings) | number:'1.2-2' }}</h4>
                                        </div>
                                    </div>
                                </div>

                                <!-- Current Value -->
                                <div class="col-md-3">
                                    <div class="card summary-card border-start-info h-100">
                                        <div class="card-body">
                                            <h6 class="text-uppercase text-muted small fw-bold mb-2">Current Value</h6>
                                            <h4 class="fw-bold text-dark mb-0">₹{{
                                                getCurrentValue(account.portfolioHoldings) | number:'1.2-2' }}</h4>
                                        </div>
                                    </div>
                                </div>

                                <!-- Total P&L -->
                                <div class="col-md-3">
                                    <div class="card summary-card h-100"
                                        [ngClass]="isOverallProfitable(account.portfolioHoldings) ? 'border-start-success' : 'border-start-danger'">
                                        <div class="card-body">
                                            <h6 class="text-uppercase text-muted small fw-bold mb-2">Total P&L</h6>
                                            <h4 class="fw-bold mb-0"
                                                [ngClass]="isOverallProfitable(account.portfolioHoldings) ? 'text-success' : 'text-danger'">
                                                {{ isOverallProfitable(account.portfolioHoldings) ? '+' : '' }}₹{{
                                                getTotalPnL(account.portfolioHoldings) | number:'1.2-2' }}
                                            </h4>
                                            <small
                                                [ngClass]="isOverallProfitable(account.portfolioHoldings) ? 'text-success' : 'text-danger'">
                                                {{ getPnLPercentage(account.portfolioHoldings) | number:'1.2-2' }}%
                                            </small>
                                        </div>
                                    </div>
                                </div>

                                <!-- Day Change -->
                                <div class="col-md-3">
                                    <div class="card summary-card h-100 border-start-warning">
                                        <div class="card-body">
                                            <h6 class="text-uppercase text-muted small fw-bold mb-2">Day Change</h6>
                                            <h4 class="fw-bold mb-0"
                                                [ngClass]="getTotalDayChange(account.portfolioHoldings) >= 0 ? 'text-success' : 'text-danger'">
                                                {{ getTotalDayChange(account.portfolioHoldings) >= 0 ? '+' : '' }}₹{{
                                                getTotalDayChange(account.portfolioHoldings) | number:'1.2-2' }}
                                            </h4>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <!-- Holdings Grid -->
                            <div class="row g-3">
                                <div class="col-lg-6 mb-3" *ngFor="let holding of account.portfolioHoldings">
                                    <div class="card summary-card h-100">
                                        <div class="card-body">
                                            <div class="d-flex justify-content-between align-items-start mb-3">
                                                <div>
                                                    <h5 class="fw-bold text-dark mb-0">{{ holding.tradingSymbol }}</h5>
                                                    <span class="badge bg-light text-secondary border">{{
                                                        holding.exchange
                                                        }}</span>
                                                </div>
                                                <div class="text-end">
                                                    <div class="fw-bold fs-5"
                                                        [ngClass]="isProfitable(holding) ? 'text-success' : 'text-danger'">
                                                        {{ isProfitable(holding) ? '+' : '' }}₹{{ holding.pnl |
                                                        number:'1.2-2' }}
                                                    </div>
                                                    <small class="text-muted d-block">P&L</small>
                                                </div>
                                            </div>

                                            <hr class="text-muted opacity-25">

                                            <div class="row g-2 text-muted small">
                                                <div class="col-6">
                                                    <span>Qty: <strong class="text-dark">{{ holding.quantity
                                                            }}</strong></span>
                                                </div>
                                                <div class="col-6 text-end">
                                                    <span>LTP: <strong class="text-dark">₹{{ holding.lastPrice |
                                                            number:'1.2-2' }}</strong></span>
                                                </div>
                                                <div class="col-6">
                                                    <span>Avg: <strong class="text-dark">₹{{ holding.averagePrice |
                                                            number:'1.2-2' }}</strong></span>
                                                </div>
                                                <div class="col-6 text-end">
                                                    <span>Cur: <strong class="text-dark">₹{{ (holding.lastPrice *
                                                            holding.quantity) | number:'1.2-2' }}</strong></span>
                                                </div>
                                            </div>
                                        </div>
                                        <div class="card-footer bg-light border-0 py-2">
                                            <div class="d-flex justify-content-between align-items-center small">
                                                <span class="text-muted">Day Change</span>
                                                <span
                                                    [ngClass]="isDayChangePositive(holding) ? 'text-success' : 'text-danger'"
                                                    class="fw-bold">
                                                    {{ isDayChangePositive(holding) ? '+' : '' }}₹{{ holding.dayChange |
                                                    number:'1.2-2' }} ({{ holding.dayChangePercentage | number:'1.2-2'
                                                    }}%)
                                                </span>
                                            </div>
                                        </div>
                                    </div>
                                </div>

                                <!-- Empty State -->
                                <div class="col-12" *ngIf="account.portfolioHoldings.length === 0">
                                    <div class="text-center py-5 text-muted">
                                        <i class="bi bi-inbox fs-1 opacity-50"></i>
                                        <p class="mt-2">No stock holdings found in this account.</p>
                                    </div>
                                </div>
                            </div>

                        </div>

                        <!-- CASE 4: MUTUAL FUNDS VIEW (Expanded to col-12) -->
                        <div *ngIf="account.broker.authenticated && account.showMutualFunds">

                            <!-- Header -->
                            <div class="d-flex justify-content-between align-items-center mb-4">
                                <div>
                                    <h4 class="fw-bold text-dark mb-1">
                                        Mutual Funds ({{ account.mutualFundHoldings.length }})
                                    </h4>
                                    <p class="text-muted mb-0 small">Account: {{ account.broker.username }}</p>
                                </div>
                                <div class="btn-group">
                                    <button class="btn btn-outline-secondary btn-sm"
                                        (click)="account.showMutualFunds = false">
                                        <i class="bi bi-arrow-left me-1"></i> Back
                                    </button>
                                    <button class="btn btn-outline-primary btn-sm" (click)="viewMutualFunds(account)"
                                        [disabled]="account.loading">
                                        <i class="bi bi-arrow-clockwise"></i>
                                    </button>
                                </div>
                            </div>

                            <!-- Summary Cards -->
                            <div class="row g-3 mb-4">
                                <!-- Total Investment -->
                                <div class="col-md-4">
                                    <div class="card summary-card border-start-primary h-100">
                                        <div class="card-body">
                                            <h6 class="text-uppercase text-muted small fw-bold mb-2">Total Investment
                                            </h6>
                                            <h4 class="fw-bold text-dark mb-0">₹{{
                                                getMFTotalInvestment(account.mutualFundHoldings) | number:'1.2-2' }}
                                            </h4>
                                        </div>
                                    </div>
                                </div>

                                <!-- Current Value -->
                                <div class="col-md-4">
                                    <div class="card summary-card border-start-info h-100">
                                        <div class="card-body">
                                            <h6 class="text-uppercase text-muted small fw-bold mb-2">Current Value</h6>
                                            <h4 class="fw-bold text-dark mb-0">₹{{
                                                getMFCurrentValue(account.mutualFundHoldings) | number:'1.2-2' }}</h4>
                                        </div>
                                    </div>
                                </div>

                                <!-- Total P&L -->
                                <div class="col-md-4">
                                    <div class="card summary-card h-100"
                                        [ngClass]="isMFOverallProfitable(account.mutualFundHoldings) ? 'border-start-success' : 'border-start-danger'">
                                        <div class="card-body">
                                            <h6 class="text-uppercase text-muted small fw-bold mb-2">Total P&L</h6>
                                            <h4 class="fw-bold mb-0"
                                                [ngClass]="isMFOverallProfitable(account.mutualFundHoldings) ? 'text-success' : 'text-danger'">
                                                {{ isMFOverallProfitable(account.mutualFundHoldings) ? '+' : '' }}₹{{
                                                getMFTotalPnL(account.mutualFundHoldings) | number:'1.2-2' }}
                                            </h4>
                                            <small
                                                [ngClass]="isMFOverallProfitable(account.mutualFundHoldings) ? 'text-success' : 'text-danger'">
                                                {{ getMFPnLPercentage(account.mutualFundHoldings) | number:'1.2-2' }}%
                                            </small>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <!-- MF Grid -->
                            <div class="row g-3">
                                <div class="col-lg-6 mb-3" *ngFor="let mf of account.mutualFundHoldings">
                                    <div class="card summary-card h-100">
                                        <div class="card-body">
                                            <div class="d-flex justify-content-between align-items-start mb-3">
                                                <div style="max-width: 70%;">
                                                    <h6 class="fw-bold text-dark mb-1 text-truncate" title="{{ mf.fund
                                                      }}">{{ mf.fund }}</h6>
                                                    <span class="badge bg-light text-secondary border">Folio: {{
                                                        mf.folio
                                                        }}</span>
                                                </div>
                                                <div class="text-end">
                                                    <div class="fw-bold fs-5"
                                                        [ngClass]="isMFProfitable(mf) ? 'text-success' : 'text-danger'">
                                                        {{ isMFProfitable(mf) ? '+' : '' }}₹{{ mf.pnl | number:'1.2-2'
                                                        }}
                                                    </div>
                                                    <small class="text-muted d-block">{{ mf.pnlPercentage |
                                                        number:'1.2-2'
                                                        }}%</small>
                                                </div>
                                            </div>

                                            <hr class="text-muted opacity-25">

                                            <div class="row g-2 text-muted small">
                                                <div class="col-6">
                                                    <span>Units: <strong class="text-dark">{{ mf.quantity
                                                            }}</strong></span>
                                                </div>
                                                <div class="col-6 text-end">
                                                    <span>NAV: <strong class="text-dark">₹{{ mf.lastPrice |
                                                            number:'1.2-2'
                                                            }}</strong></span>
                                                </div>
                                                <div class="col-6">
                                                    <span>Inv: <strong class="text-dark">₹{{ mf.investedAmount |
                                                            number:'1.2-2' }}</strong></span>
                                                </div>
                                                <div class="col-6 text-end">
                                                    <span>Cur: <strong class="text-dark">₹{{ mf.currentValue |
                                                            number:'1.2-2' }}</strong></span>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>

                                <!-- Empty State -->
                                <div class="col-12" *ngIf="account.mutualFundHoldings.length === 0">
                                    <div class="text-center py-5 text-muted">
                                        <i class="bi bi-inbox fs-1 opacity-50"></i>
                                        <p class="mt-2">No mutual funds found in this account.</p>
                                    </div>
                                </div>
                            </div>

                        </div>

                    </div>
                </ng-container>

                <!-- ADD NEW ACCOUNT CARD (Compact) -->
                <div class="col-md-6" [ngClass]="{'d-none': showOnboardingForm}">
                    <div class="card h-100 border-dashed border-2 bg-light text-center d-flex align-items-center justify-content-center"
                        style="min-height: 480px; cursor: pointer;" (click)="toggleOnboardingForm()">
                        <div class="py-4">
                            <div class="icon-circle bg-white shadow-sm mx-auto mb-3 text-primary">
                                <i class="bi bi-plus-lg"></i>
                            </div>
                            <h6 class="text-muted fw-bold">Link Another Account</h6>
                            <p class="text-muted small">Connect another Zerodha account</p>
                        </div>
                    </div>
                </div>

                <!-- ONBOARDING FORM (Compact) -->
                <div class="col-md-6" *ngIf="showOnboardingForm">
                    <div class="card h-100 summary-card">
                        <div class="card-header bg-white border-0 pt-3">
                            <div class="d-flex justify-content-between align-items-center">
                                <h5 class="fw-bold mb-0">Link New Account</h5>
                                <button type="button" class="btn-close" (click)="toggleOnboardingForm()"></button>
                            </div>
                        </div>
                        <div class="card-body d-flex flex-column justify-content-center">
                            <p class="text-muted small mb-4">Enter the Client ID provided by Zerodha to securely link
                                your
                                portfolio.</p>
                            <div class="mb-4">
                                <label class="form-label text-muted small fw-bold">Client ID</label>
                                <input type="text" class="form-control form-control-lg" placeholder="e.g. AB1234"
                                    [(ngModel)]="onboardingClientId">
                            </div>
                            <button class="btn btn-primary btn-lg w-100" (click)="onboardZerodhaAccount()"
                                [disabled]="onboardingLoading">
                                <span *ngIf="!onboardingLoading">Onboard Account</span>
                                <span *ngIf="onboardingLoading" class="spinner-border spinner-border-sm"></span>
                            </button>
                        </div>
                    </div>
                </div>
            </div>

        </div>

        <!-- ============================================== -->
        <!-- TAB: OTHER INVESTMENTS -->
        <!-- ============================================== -->
        <div *ngIf="activeTab === 'other'" class="fade-in">

            <div class="row g-4 mb-5">
                <!-- NPS Cards -->
                <div class="col-md-6" *ngFor="let nps of npsAccountsList">
                    <div class="card summary-card border-none shadow-sm h-100">
                        <div class="card-body">
                            <div class="d-flex justify-content-between align-items-center mb-3">
                                <div class="d-flex align-items-center">
                                    <div class="icon-square bg-warning-subtle text-warning me-3 rounded p-2"><i
                                            class="bi bi-umbrella"></i></div>
                                    <h6 class="fw-bold mb-0">National Pension System (NPS)</h6>
                                </div>
                                <div class="btn-group btn-group-sm">
                                    <button class="btn btn-link text-primary p-0 me-2" (click)="onEdit(nps)"
                                        title="Edit">
                                        <i class="bi bi-pencil"></i>
                                    </button>
                                    <button class="btn btn-link text-danger p-0" (click)="onDelete(nps)" title="Delete">
                                        <i class="bi bi-trash"></i>
                                    </button>
                                </div>
                            </div>
                            <div class="d-flex justify-content-between mb-2">
                                <span class="text-muted small">Scheme</span>
                                <span class="fw-bold small">{{ nps.name }}</span>
                            </div>
                            <div class="d-flex justify-content-between">
                                <span class="text-muted small">Total Holdings</span>
                                <span class="fw-bold text-success">₹{{ nps.balance | number:'1.2-2' }}</span>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- PPF Cards -->
                <div class="col-md-6" *ngFor="let ppf of ppfAccountsList">
                    <div class="card summary-card border-none shadow-sm h-100">
                        <div class="card-body">
                            <div class="d-flex justify-content-between align-items-center mb-3">
                                <div class="d-flex align-items-center">
                                    <div class="icon-square bg-info-subtle text-info me-3 rounded p-2"><i
                                            class="bi bi-piggy-bank"></i></div>
                                    <h6 class="fw-bold mb-0">Public Provident Fund (PPF)</h6>
                                </div>
                                <div class="btn-group btn-group-sm">
                                    <button class="btn btn-link text-primary p-0 me-2" (click)="onEdit(ppf)"
                                        title="Edit">
                                        <i class="bi bi-pencil"></i>
                                    </button>
                                    <button class="btn btn-link text-danger p-0" (click)="onDelete(ppf)" title="Delete">
                                        <i class="bi bi-trash"></i>
                                    </button>
                                </div>
                            </div>
                            <div class="d-flex justify-content-between mb-2">
                                <span class="text-muted small">Maturity</span>
                                <span class="fw-bold small">{{ ppf.startDate | date }}</span>
                            </div>
                            <div class="d-flex justify-content-between">
                                <span class="text-muted small">Balance</span>
                                <span class="fw-bold text-success">₹{{ ppf.balance | number:'1.2-2' }}</span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Other Mutual Funds List -->
            <div class="mt-4" *ngIf="otherMutualFunds.length > 0">
                <h6 class="fw-bold text-secondary mb-3 small text-uppercase">External Mutual Funds</h6>
                <div class="card border-0 shadow-sm">
                    <div class="table-responsive">
                        <table class="table table-hover align-middle mb-0">
                            <thead class="bg-light">
                                <tr>
                                    <th class="ps-4">Fund Name</th>
                                    <th>NAV</th>
                                    <th class="text-end pe-4">Current Value</th>
                                    <th class="text-center">Actions</th>
                                </tr>
                            </thead>
                            <tbody>
                                <tr *ngFor="let fund of otherMutualFunds">
                                    <td class="ps-4 fw-bold">{{ fund.fundName }}</td>
                                    <td>{{ fund.nav }}</td>
                                    <td class="text-end pe-4 fw-bold">₹{{ fund.currentValue | number:'1.2-2' }}</td>
                                    <td class="text-center">
                                        <div class="btn-group btn-group-sm">
                                            <button class="btn btn-link text-primary p-0 me-2"
                                                (click)="onEdit(fund.portfolioObj)" title="Edit">
                                                <i class="bi bi-pencil"></i>
                                            </button>
                                            <button class="btn btn-link text-danger p-0"
                                                (click)="onDelete(fund.portfolioObj)" title="Delete">
                                                <i class="bi bi-trash"></i>
                                            </button>
                                        </div>
                                    </td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>

        <!-- Disconnect Modal -->
        <div class="modal fade show d-block" tabindex="-1" *ngIf="showDisconnectModal"
            style="background-color: rgba(0,0,0,0.5);">
            <div class="modal-dialog modal-dialog-centered">
                <div class="modal-content border-0 shadow-lg">
                    <div class="modal-header border-0 pb-0">
                        <button type="button" class="btn-close" (click)="cancelDisconnect()"></button>
                    </div>
                    <div class="modal-body py-4 text-center">
                        <p class="mb-1 fw-bold fs-5">{{ accountToDisconnect?.broker?.username }}</p>
                        <p class="text-muted small">Are you sure you want to disconnect your zerodha account?</p>
                    </div>
                    <div class="modal-footer border-0 justify-content-center pb-4">
                        <button class="btn btn-light px-4 me-2" (click)="cancelDisconnect()">Cancel</button>
                        <button class="btn btn-danger px-4" (click)="confirmDisconnect()">Yes, Disconnect</button>
                    </div>
                </div>
            </div>
        </div>

    </div>
</div>