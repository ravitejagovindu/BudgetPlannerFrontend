<div class="container-fluid ledger-container fade-in">

  <!-- Page Header -->
  <div class="row mb-4">
    <div class="col-md-8">
      <h1 class="page-title">
        <i class="bi bi-journal-text me-2"></i>Financial Ledger
      </h1>
      <p class="page-subtitle">Track and manage all your financial transactions</p>
    </div>
    <div class="col-md-4">
      <div class="header-controls">
        <app-month-picker [currentMonthYear]="currentMonthYear" (monthSelect)="populateLedgers($event)">
        </app-month-picker>
      </div>
    </div>
  </div>

  <!-- Add Transaction Form -->
  <div class="card border-0 shadow-sm mb-4">
    <div class="card-header bg-white py-3 border-bottom">
      <h5 class="card-title mb-0 text-dark fw-bold">
        <i class="bi bi-plus-circle me-2 text-primary"></i>Add New Transaction
      </h5>
    </div>
    <div class="card-body p-4">
      <form [formGroup]="ledgerEntry" (ngSubmit)="saveLedger()" novalidate>
        <div class="row gx-4 gy-3 align-items-end">
          <div class="col-md">
            <label for="calendar" class="form-label fw-bold text-secondary small">Date</label>
            <input type="date" id="calendar" min="{{ minDate }}" max="{{ maxDate }}" formControlName="date"
              class="form-control" required />
          </div>

          <div class="col-md">
            <label for="typeSelect" class="form-label fw-bold text-secondary small">Type</label>
            <select id="typeSelect" formControlName="type" class="form-select" (change)="showDropdowns()" required>
              <option value="" disabled selected>Select Type</option>
              <option *ngFor="let option of allTypes | keyvalue" [value]="option.key">
                {{ option.key }}
              </option>
            </select>
          </div>

          <div class="col-md">
            <label for="categorySelect" class="form-label fw-bold text-secondary small">Category</label>
            <select id="categorySelect" formControlName="category" class="form-select" (change)="showSubCategories()"
              required>
              <option value="" disabled selected>Select Category</option>
              <option *ngFor="let option of categories" [value]="option">
                {{ option }}
              </option>
            </select>
          </div>

          <div class="col-md">
            <label for="subCategorySelect" class="form-label fw-bold text-secondary small">Subcategory</label>
            <select id="subCategorySelect" formControlName="subCategory" class="form-select" required>
              <option value="" disabled selected>Select Subcategory</option>
              <option *ngFor="let option of subCategories" [value]="option">
                {{ option }}
              </option>
            </select>
          </div>

          <div class="col-md">
            <label for="amountInput" class="form-label fw-bold text-secondary small">Amount (₹)</label>
            <div class="input-group">
              <span class="input-group-text bg-light border-end-0">₹</span>
              <input id="amountInput" type="number" formControlName="amount" class="form-control border-start-0"
                placeholder="0.00" min="0" step="0.01" required />
            </div>
          </div>

          <div class="col-md" *ngIf="(ledgerEntry.get('type')?.value || '') !== 'INCOME'">
            <label for="paidBySelect" class="form-label fw-bold text-secondary small">Paid By</label>
            <select id="paidBySelect" formControlName="paidBy" class="form-select" required>
              <option value="" disabled selected>Select Payer</option>
              <option *ngFor="let option of paymentModes" [value]="option">
                {{ option }}
              </option>
            </select>
          </div>

          <div class="col-md-12">
            <label for="description" class="form-label fw-bold text-secondary small">
              <i class="bi bi-journal-text me-1"></i>Notes
            </label>
            <input id="description" type="text" formControlName="description" class="form-control"
              placeholder="Add a description..." />
          </div>

          <div class="col-12 text-end mt-3 border-top pt-3">
            <button type="button" class="btn btn-light me-2" (click)="ledgerEntry.reset()">Reset</button>
            <button type="submit" [disabled]="!ledgerEntry.valid" class="btn btn-primary px-4">
              <i class="bi bi-plus-lg me-2"></i>Add Entry
            </button>
          </div>
        </div>
      </form>
    </div>
  </div>

  <!-- Expense Records Section -->
  <div class="card border-0 shadow-sm">
    <div class="card-header bg-white py-3 border-bottom d-flex justify-content-between align-items-center">
      <h5 class="card-title mb-0 text-dark fw-bold">
        <i class="bi bi-list-ul me-2 text-primary"></i>Expense Records
      </h5>
      <button class="btn btn-outline-secondary btn-sm" (click)="exportLedgerTableToExcel()" title="Download Excel">
        <i class="bi bi-download me-1"></i> Export
      </button>
    </div>

    <!-- Filter Bar -->
    <div class="card-body bg-light border-bottom p-3">
      <div class="row g-2 align-items-center">
        <div class="col-md-3">
          <div class="input-group input-group-sm">
            <span class="input-group-text bg-white border-end-0"><i class="bi bi-search text-muted"></i></span>
            <input type="text" id="searchInput" class="form-control border-start-0" placeholder="Search records..."
              [(ngModel)]="filterText" (input)="onFilterChange()">
          </div>
        </div>
        <div class="col-md-2">
          <select class="form-select form-select-sm" [(ngModel)]="filterType" (change)="onFilterChange()">
            <option value="">All Types</option>
            <option *ngFor="let type of availableTypes" [value]="type">{{ type }}</option>
          </select>
        </div>
        <div class="col-md-2">
          <select class="form-select form-select-sm" [(ngModel)]="filterCategory" (change)="onFilterChange()">
            <option value="">All Categories</option>
            <option *ngFor="let category of availableCategories" [value]="category">{{ category }}</option>
          </select>
        </div>
        <div class="col-md-2">
          <select class="form-select form-select-sm" [(ngModel)]="filterPaidBy" (change)="onFilterChange()">
            <option value="">All Accounts</option>
            <option *ngFor="let paidBy of availablePaidBy" [value]="paidBy">{{ paidBy }}</option>
          </select>
        </div>
        <div class="col-md-3 text-end">
          <small class="text-muted d-block me-2" *ngIf="filterType || filterCategory || filterPaidBy || filterText">
            {{ filteredRecords.length }} matching records
          </small>
          <button *ngIf="filterType || filterCategory || filterPaidBy || filterText"
            class="btn btn-link btn-sm text-decoration-none text-danger p-0" (click)="clearFilters()">
            Clear Filters
          </button>
        </div>
      </div>
    </div>

    <div class="table-responsive">
      <table class="table align-middle table-hover mb-0" id="ledger-table">
        <thead>
          <tr>
            <th style="cursor: pointer;" (click)="onSortChange('date')">
              Date <i class="bi ms-1" [ngClass]="getSortIcon('date')"></i>
            </th>
            <th style="cursor: pointer;" (click)="onSortChange('type')">
              Type <i class="bi ms-1" [ngClass]="getSortIcon('type')"></i>
            </th>
            <th style="cursor: pointer;" (click)="onSortChange('category')">
              Category <i class="bi ms-1" [ngClass]="getSortIcon('category')"></i>
            </th>
            <th style="cursor: pointer;" (click)="onSortChange('subCategory')">
              Subcategory <i class="bi ms-1" [ngClass]="getSortIcon('subCategory')"></i>
            </th>
            <th style="cursor: pointer;" (click)="onSortChange('paidBy')">
              Paid By <i class="bi ms-1" [ngClass]="getSortIcon('paidBy')"></i>
            </th>
            <th class="text-end" style="cursor: pointer;" (click)="onSortChange('amount')">
              Amount (₹) <i class="bi ms-1" [ngClass]="getSortIcon('amount')"></i>
            </th>
            <th class="text-end" style="cursor: pointer;" (click)="onSortChange('notes')">
              Notes<i class="bi ms-1" [ngClass]="getSortIcon('notes')"></i>
            </th>
            <th class="text-center">Actions</th>
          </tr>
        </thead>
        <tbody>
          <tr *ngFor="let entry of filteredRecords">
            <td>
              <ng-container *ngIf="entry.canEdit; else showDate">
                <input type="date" class="form-control form-control-sm" [(ngModel)]="entry.date"
                  aria-label="Edit date" />
              </ng-container>
              <ng-template #showDate>
                <span class="font-monospace text-dark">{{ entry.date }}</span>
              </ng-template>
            </td>
            <td>
              <ng-container *ngIf="entry.canEdit; else showType">
                <input type="text" class="form-control form-control-sm" [(ngModel)]="entry.type"
                  aria-label="Edit type" />
              </ng-container>
              <ng-template #showType>
                <span class="badge bg-light text-dark border">{{ entry.type }}</span>
              </ng-template>
            </td>
            <td>
              <ng-container *ngIf="entry.canEdit; else showCategory">
                <input type="text" class="form-control form-control-sm" [(ngModel)]="entry.category"
                  aria-label="Edit category" />
              </ng-container>
              <ng-template #showCategory>
                <span class="fw-medium">{{ entry.category }}</span>
              </ng-template>
            </td>
            <td>
              <ng-container *ngIf="entry.canEdit; else showSubCategory">
                <input type="text" class="form-control form-control-sm" [(ngModel)]="entry.subCategory"
                  aria-label="Edit sub category" />
              </ng-container>
              <ng-template #showSubCategory>
                <span class="text-secondary small">{{ entry.subCategory }}</span>
              </ng-template>
            </td>
            <td>
              <ng-container *ngIf="entry.canEdit; else showPaidBy">
                <input type="text" class="form-control form-control-sm" [(ngModel)]="entry.paidBy"
                  aria-label="Edit paidBy" />
              </ng-container>
              <ng-template #showPaidBy>
                <span class="text-dark small">{{ entry.paidBy }}</span>
              </ng-template>
            </td>
            <td class="text-end fw-bold font-monospace">
              <ng-container *ngIf="entry.canEdit; else showAmount">
                <input type="number" step="0.01" class="form-control form-control-sm text-end"
                  [(ngModel)]="entry.amount" aria-label="Edit amount" />
              </ng-container>
              <ng-template #showAmount>
                <span [class.text-success]="entry.type === 'INCOME'" [class.text-danger]="entry.type === 'EXPENSE'">
                  ₹{{ entry.amount | number:'1.2-2' }}
                </span>
              </ng-template>
            </td>
            <td class="text-end">
              <ng-container *ngIf="entry.canEdit; else showDescription">
                <input type="text" class="form-control form-control-sm text-end" [(ngModel)]="entry.description"
                  aria-label="Edit description" />
              </ng-container>
              <ng-template #showDescription>
                <span class="text-muted small fst-italic">{{ entry.description }}</span>
              </ng-template>
            </td>
            <td class="text-center">
              <div class="btn-group btn-group-sm">
                <button type="button" class="btn btn-outline-primary" (click)="updateLedger(entry)"
                  title="{{ entry.canEdit ? 'Save' : 'Edit' }}">
                  <i class="bi" [ngClass]="entry.canEdit ? 'bi-check-lg' : 'bi-pencil'"></i>
                </button>
                <button type="button" class="btn btn-outline-danger" (click)="deleteLedger(entry)"
                  title="{{ entry.canEdit ? 'Cancel' : 'Delete' }}">
                  <i class="bi" [ngClass]="entry.canEdit ? 'bi-x-lg' : 'bi-trash'"></i>
                </button>
              </div>
            </td>
          </tr>
          <tr *ngIf="!filteredRecords || filteredRecords.length === 0">
            <td colspan="8" class="text-center text-muted py-5">
              <div class="d-flex flex-column align-items-center">
                <i class="bi bi-inbox fs-1 mb-2 text-light-gray"></i>
                <p class="mb-0">No records found matching your criteria</p>
              </div>
            </td>
          </tr>
        </tbody>
      </table>
    </div>
  </div>

</div>